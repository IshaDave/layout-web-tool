{#-#################################################################
<File Name>
  software_supply_chain.html

<Author>
  Lukas Puehringer <lukas.puehringer@nyu.edu>

<Started>
  Apr 06, 2017

<Copyright>
  See LICENSE for licensing information.

<Purpose>
  Shows generated software supply chain graph (steps) as visual
  D3 graph and as modifiable and sortable form elements.

#################################################################-#}
{% import "_macros.html" as macros %}
{% import "_ssc_macros.html" as ssc_macros %}
{% extends "base.html" %}

{#- BEGIN: Software Supply Chain item (step and inspection) form macro -#}
{#- END: Software Supply Chain item (step and inspection) form macro -#}

{#- BEGIN: Rendered content -#}
{% block content %}
  <script type="text/javascript">
    $(function(){
      /*
       * Initialize SVG viewBox width and height to the current container width
       * and height viewBox (and its contents) get scaled on windowResize
       * preserving aspectRatio.
       * FIXME: The height of the SVG container should scale together with the
       * width of the viewBox as does the height of the viewBox
       */
      var svg_width = $(".svg-container").width();
      var svg_height = $(".svg-container").height();
      $("svg").attr("viewBox", [0, 0, svg_width, svg_height].join(" "));

      var graph_data = generate_graph_from_ssc_steps();
      draw_graph(graph_data);

      /*
       * Re-generate/re-draw the graph when ssc step type changes
       */
      $(document).on("change", ".step-modifies-checkbox", function(){
        // Workaround: Checkboxes are only posted if checked, but we need a
        // value per step to be able to aggregate step values by index.
        var checked = $(this).is(':checked');
        $(this).prev("input[name='step_modifies[]']").val(checked);

        // Re-generate/re-draw graph
        draw_graph(generate_graph_from_ssc_steps());
      });
    });
  </script>

  {{ macros.progress_bar(value=60) }}

  <hr>
  {% if show_refresh %}
  <div class="alert alert-warning mb-5" role="alert">
    We saw that you revisited a previous page. Click
    <a href="{{ url_for('software_supply_chain', refresh=True)}}">here to
    re-generate the software supply chain</a> on this page! <br> But
    <strong>be warned</strong>, this will overwrite any changes you have
    already made on this page.
  </div>
  {% endif %}

  <h1>Is this what your software supply chain looks like?</h1>
  <p>Based on what you told us on the previous pages we have generated a
    preliminary software supply chain. Please add, remove, modify and re-order
    the steps below so that they align with your workflow.</p>
  {#- BEGIN: Container for software supply chain D3 graph -#}
  <div class="svg-container mt-3 mb-3">
    <svg version="1.1" viewBox="0 0 1 1" preserveAspectRatio="xMinYMin meet" class="svg-content"></svg>
  </div>
  {#- END: Container for software supply chain D3 graph -#}

  {#- BEGIN: Postable Form Content -#}
  <div class="ssc-items mt-5">
    {#- Hidden form add templates (not posted) -#}
    {{ ssc_macros.item_form("step", template=true) }}
    {{ ssc_macros.item_form("inspection", template=true) }}
    <form id="ssc-form" method="POST" action="{{ url_for('software_supply_chain')}}">
      <h2 class="mt-4 mb-2">These are the commands you run as part of your software supply chain</h2>
        <p>We distinguish between <i>modifying</i> and <i>non-modifying </i> steps.
          Modifying steps change your software product (e.g. building steps),
          whereas non-modifying steps don't (e.g. testing steps).

      <div class="ssc-steps sort-container mb-2">
        {% for step in ssc_data.steps %}
          {{ ssc_macros.item_form("step", item=step) }}
        {% endfor %}
      </div>
      <button type="button" data-templatesource=".ssc-step" data-templatedest=".ssc-steps" class="add-btn btn-outline-primary btn">Add Step</button>

      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    </form>
  </div>
  {#- END: Postable Form Content -#}

  {#- BEGIN: Navigation Footer (Previous/Next) -#}
  <hr>
  <div class="row no-gutters justify-content-between">
    <div class="col-3">
      <a class="btn btn-outline-primary btn-block" href="{{ url_for('packaging')}}">Previous</a>
    </div>
    <div class="col-3">
      <input type="submit" form="ssc-form" class="btn btn-outline-primary btn-block" value="Next">
    </div>
  </div>
  {#- END: Navigation Footer (Previous/Next) -#}
{% endblock %}
{#- END: Rendered content -#}

