{% import '_macros.html' as macros %}
{% extends "base.html" %}

{# BEGIN: Rendered content #}
{% block content %}
  {{ macros.progress_bar(value=80) }}
  <hr>
  <h1>Security Restriction Assessment (linking the chain)</h1>
  {{ lipsum(n=1, html=True, min=80, max=81) }}

  {# BEGIN: Mock run command snippet  #}
  <h2 class="mt-5 mb-2">Copy/Paste Commands</h2>
  <div>
<pre class="code">
{% for item in items %}
{%- if item.type == "step" -%}
in-toto-mock --name {{item.name}} -- {{item.cmd}}
{% endif %}
{%- endfor -%}
</pre>
  </div>
  {# END: Mock run command snippet  #}

  {# BEGIN: Link file upload dropzone #}
  <script type="text/javascript">
    {# Initialize drag and drop file upload for pubkey uploads #}
    {# FIXME: Factor out to JavaScript file #}
    {# FIXME: DRY!!! c.f. authorizing #}
    Dropzone.autoDiscover = false;
    $(function(){

      $(".dropzone").dropzone({
          paramName: "step_link",

          init: function () {
            // Show already uploaded files in dropzone
            {% for item in items %}
              {% if link_dict.get(item.name) %}
                var dropzone_file = {
                  name: "{{ link_dict.get(item.name) }}"
                };

                this.options.addedfile.call(this, dropzone_file);
                dropzone_file.previewElement.classList.add('dz-complete');
              {% endif %}
            {% endfor %}
          },
          success: function(file, response) {
            // Remove the file place holder from the dropzone if the upload failed
            if (response.error) {
              this.removeFile(file);
            }
            show_message(response.flash.msg, response.flash.type);
          }
      });
    });
  </script>
  <h2 class="mt-5 mb-2">Upload Links</h2>
  <small>Drop Links here or click to upload!</small>
  <div class="dz-container d-flex align-items-stretch p-3">
    <form class="dropzone d-flex flex-wrap" method="POST", enctype="multipart/form-data"
        action="{{ url_for('ajax_upload_link') }}">
    </form>
  </div>
  {# END: Link file upload dropzone #}

  {# BEGIN: Navigation Footer (Previous/Next) #}
  <hr>
  <div class="row no-gutters justify-content-between">
    <div class="col-3">
      <a class="btn btn-primary btn-block" href="{{ url_for('authorizing')}} ">Previous</a>
    </div>
    <div class="col-3">
      <a class="btn btn-primary btn-block" href="{{ url_for('wrap_up')}} ">Next</a>
    </div>
  </div>
  {# END: Navigation Footer (Previous/Next) #}
{% endblock %}
{# END: Rendered content #}
